{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/abbylossa/soccerconnect-admin/src/utils/auth.ts"],"sourcesContent":["// src/utils/auth.ts\n//\n// SERVER-ONLY AUTH HELPERS\n//\n// - Reads sb-access-token / sb-refresh-token from cookies (Next 16 style)\n// - Uses service role key ONLY on the server to validate the user\n// - Gives you getCurrentUser() for \"am I logged in?\"\n// - Gives you requireUser() for protected routes\n//\n// IMPORTANT: don't import this from Client Components.\n\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { createClient, type User } from \"@supabase/supabase-js\";\n\n// ----- ENV VARS (typed + runtime check) -----\nconst SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL as string;\nconst SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY as string;\n\nif (!SUPABASE_URL || !SERVICE_ROLE_KEY) {\n  throw new Error(\n    \"[auth.ts] Missing Supabase env vars. Check NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY.\"\n  );\n}\n\n// Create a *server-only* supabase client that can validate tokens.\n// NOTE: SERVICE_ROLE_KEY never goes to browser.\nfunction getServiceClient() {\n  return createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {\n    auth: {\n      persistSession: false,\n      autoRefreshToken: false,\n    },\n  });\n}\n\n// Helper to read the auth cookies from Next 16's async cookies()\nasync function readAuthCookies() {\n  // cookies() is async in Next 16, so we MUST await it\n  const cookieStore = await cookies();\n\n  // In prod we'll have two cookies we set at login\n  //   sb-access-token\n  //   sb-refresh-token\n  //\n  // BUT on localhost, Next dev tools will sometimes try to\n  // read+JSON.parse preview cookies (like \"base64-...\"),\n  // which can explode. We'll defensively guard against that.\n\n  const getCookie = (name: string): string | undefined => {\n    try {\n      const c = cookieStore.get(name);\n      // c is { name, value, ... } or undefined\n      if (!c) return undefined;\n      return c.value;\n    } catch (err) {\n      console.warn(\n        `[auth.ts] failed to read cookie \"${name}\":`,\n        (err as Error).message\n      );\n      return undefined;\n    }\n  };\n\n  const accessToken = getCookie(\"sb-access-token\");\n  const refreshToken = getCookie(\"sb-refresh-token\");\n\n  return { accessToken, refreshToken };\n}\n\n// Public helper: are they logged in? (does NOT redirect)\n// ----------------------------------------------------------------\nexport async function getCurrentUser(): Promise<{\n  user: User | null;\n  redirectToLogin: boolean;\n}> {\n  const { accessToken, refreshToken } = await readAuthCookies();\n\n  if (!accessToken || !refreshToken) {\n    // no session cookies at all\n    return {\n      user: null,\n      redirectToLogin: true,\n    };\n  }\n\n  const supabaseServer = getServiceClient();\n\n  // 1. Try to verify the access token against Supabase\n  const { data: userResult, error: userErr } =\n    await supabaseServer.auth.getUser(accessToken);\n\n  if (userErr || !userResult.user) {\n    // Access token might be expired, try refresh flow\n    const { data: refreshed, error: refreshErr } =\n      await supabaseServer.auth.refreshSession({\n        refresh_token: refreshToken,\n      });\n\n    if (refreshErr || !refreshed.session?.user) {\n      // refresh also failed -> no valid session\n      return {\n        user: null,\n        redirectToLogin: true,\n      };\n    }\n\n    // refresh succeeded -> the refreshed.session has new tokens,\n    // BUT: we do NOT silently rewrite cookies here.\n    // Why? We're in a helper that might be called during render,\n    // and setCookie() in the middle of a render causes weirdness.\n    //\n    // Instead we just treat them as logged in for now.\n    return {\n      user: refreshed.session.user,\n      redirectToLogin: false,\n    };\n  }\n\n  // access token was valid\n  return {\n    user: userResult.user,\n    redirectToLogin: false,\n  };\n}\n\n// Strict helper for protected routes/pages\n// Call this at the top of /protected/... pages.\n// If not logged in, it will redirect(\"/login\") on the server.\n// ----------------------------------------------------------------\nexport async function requireUser(): Promise<User> {\n  const { user, redirectToLogin } = await getCurrentUser();\n\n  if (redirectToLogin || !user) {\n    redirect(\"/login\");\n  }\n\n  return user;\n}\n"],"names":[],"mappings":"AAAA,oBAAoB;AACpB,EAAE;AACF,2BAA2B;AAC3B,EAAE;AACF,0EAA0E;AAC1E,kEAAkE;AAClE,qDAAqD;AACrD,iDAAiD;AACjD,EAAE;AACF,uDAAuD;;;;;;;AAEvD;AACA;AAAA;AACA;;;;AAEA,+CAA+C;AAC/C,MAAM;AACN,MAAM,mBAAmB,QAAQ,GAAG,CAAC,yBAAyB;AAE9D,IAAI,CAAC,gBAAgB,CAAC,kBAAkB;IACtC,MAAM,IAAI,MACR;AAEJ;AAEA,mEAAmE;AACnE,gDAAgD;AAChD,SAAS;IACP,OAAO,IAAA,uMAAY,EAAC,cAAc,kBAAkB;QAClD,MAAM;YACJ,gBAAgB;YAChB,kBAAkB;QACpB;IACF;AACF;AAEA,iEAAiE;AACjE,eAAe;IACb,qDAAqD;IACrD,MAAM,cAAc,MAAM,IAAA,0IAAO;IAEjC,iDAAiD;IACjD,oBAAoB;IACpB,qBAAqB;IACrB,EAAE;IACF,yDAAyD;IACzD,uDAAuD;IACvD,2DAA2D;IAE3D,MAAM,YAAY,CAAC;QACjB,IAAI;YACF,MAAM,IAAI,YAAY,GAAG,CAAC;YAC1B,yCAAyC;YACzC,IAAI,CAAC,GAAG,OAAO;YACf,OAAO,EAAE,KAAK;QAChB,EAAE,OAAO,KAAK;YACZ,QAAQ,IAAI,CACV,CAAC,iCAAiC,EAAE,KAAK,EAAE,CAAC,EAC5C,AAAC,IAAc,OAAO;YAExB,OAAO;QACT;IACF;IAEA,MAAM,cAAc,UAAU;IAC9B,MAAM,eAAe,UAAU;IAE/B,OAAO;QAAE;QAAa;IAAa;AACrC;AAIO,eAAe;IAIpB,MAAM,EAAE,WAAW,EAAE,YAAY,EAAE,GAAG,MAAM;IAE5C,IAAI,CAAC,eAAe,CAAC,cAAc;QACjC,4BAA4B;QAC5B,OAAO;YACL,MAAM;YACN,iBAAiB;QACnB;IACF;IAEA,MAAM,iBAAiB;IAEvB,qDAAqD;IACrD,MAAM,EAAE,MAAM,UAAU,EAAE,OAAO,OAAO,EAAE,GACxC,MAAM,eAAe,IAAI,CAAC,OAAO,CAAC;IAEpC,IAAI,WAAW,CAAC,WAAW,IAAI,EAAE;QAC/B,kDAAkD;QAClD,MAAM,EAAE,MAAM,SAAS,EAAE,OAAO,UAAU,EAAE,GAC1C,MAAM,eAAe,IAAI,CAAC,cAAc,CAAC;YACvC,eAAe;QACjB;QAEF,IAAI,cAAc,CAAC,UAAU,OAAO,EAAE,MAAM;YAC1C,0CAA0C;YAC1C,OAAO;gBACL,MAAM;gBACN,iBAAiB;YACnB;QACF;QAEA,6DAA6D;QAC7D,gDAAgD;QAChD,6DAA6D;QAC7D,8DAA8D;QAC9D,EAAE;QACF,mDAAmD;QACnD,OAAO;YACL,MAAM,UAAU,OAAO,CAAC,IAAI;YAC5B,iBAAiB;QACnB;IACF;IAEA,yBAAyB;IACzB,OAAO;QACL,MAAM,WAAW,IAAI;QACrB,iBAAiB;IACnB;AACF;AAMO,eAAe;IACpB,MAAM,EAAE,IAAI,EAAE,eAAe,EAAE,GAAG,MAAM;IAExC,IAAI,mBAAmB,CAAC,MAAM;QAC5B,IAAA,iMAAQ,EAAC;IACX;IAEA,OAAO;AACT","debugId":null}},
    {"offset": {"line": 160, "column": 0}, "map": {"version":3,"sources":["file:///Users/abbylossa/soccerconnect-admin/src/app/protected/layout.tsx"],"sourcesContent":["import { getCurrentUser } from \"@/utils/auth\";\nimport Link from \"next/link\";\nimport { Toaster } from \"react-hot-toast\";\nimport { redirect } from \"next/navigation\";\n\nexport const metadata = {\n  title: \"SoccerConnect Admin\",\n  description: \"Internal moderation console for SoccerConnect\",\n};\n\nexport default async function ProtectedLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  const user = await getCurrentUser();\n\n  // pull role from app_metadata first, then user_metadata\n  const roleFromApp = (user as any)?.app_metadata?.role;\n  const roleFromUser = (user as any)?.user_metadata?.role;\n  const role = roleFromApp || roleFromUser || \"user\";\n\n  // Not signed in? go to login\n  if (!user) {\n    redirect(\"/login\");\n  }\n\n  // Signed in but not admin? also go to login (or could redirect to \"/\")\n  if (role !== \"admin\") {\n    redirect(\"/login\");\n  }\n\n  return (\n    <html lang=\"en\">\n      <body className=\"bg-gray-50 text-gray-900 min-h-screen flex flex-col\">\n        <header className=\"border-b bg-white shadow-sm sticky top-0 z-20\">\n          <div className=\"mx-auto max-w-7xl px-6 py-3 flex items-center justify-between\">\n            <Link\n              href=\"/protected\"\n              className=\"text-lg font-semibold text-blue-700 hover:text-blue-900\"\n            >\n              SoccerConnect â€¢ Admin\n            </Link>\n\n            <nav className=\"flex items-center gap-6 text-sm font-medium text-gray-700\">\n              <Link\n                href=\"/protected\"\n                className=\"hover:text-blue-600 transition\"\n              >\n                Dashboard\n              </Link>\n\n              <Link\n                href=\"/protected/flagged\"\n                className=\"hover:text-blue-600 transition\"\n              >\n                Flagged\n              </Link>\n\n              <Link\n                href=\"/protected/reports\"\n                className=\"hover:text-blue-600 transition\"\n              >\n                Reports\n              </Link>\n\n              <span className=\"text-gray-500 text-xs\">\n                {user?.email ?? \"Signed in\"}\n              </span>\n\n              <Link\n                href=\"/api/auth/signout\"\n                className=\"text-red-500 hover:text-red-700\"\n              >\n                Logout\n              </Link>\n            </nav>\n          </div>\n        </header>\n\n        <main className=\"flex-1 mx-auto w-full max-w-7xl px-6 py-8\">\n          {children}\n        </main>\n\n        <Toaster position=\"bottom-right\" />\n      </body>\n    </html>\n  );\n}\n"],"names":[],"mappings":";;;;;;;AAAA;AACA;AACA;AACA;AAAA;;;;;;AAEO,MAAM,WAAW;IACtB,OAAO;IACP,aAAa;AACf;AAEe,eAAe,gBAAgB,EAC5C,QAAQ,EAGT;IACC,MAAM,OAAO,MAAM,IAAA,sIAAc;IAEjC,wDAAwD;IACxD,MAAM,cAAe,MAAc,cAAc;IACjD,MAAM,eAAgB,MAAc,eAAe;IACnD,MAAM,OAAO,eAAe,gBAAgB;IAE5C,6BAA6B;IAC7B,IAAI,CAAC,MAAM;QACT,IAAA,iMAAQ,EAAC;IACX;IAEA,uEAAuE;IACvE,IAAI,SAAS,SAAS;QACpB,IAAA,iMAAQ,EAAC;IACX;IAEA,qBACE,8OAAC;QAAK,MAAK;kBACT,cAAA,8OAAC;YAAK,WAAU;;8BACd,8OAAC;oBAAO,WAAU;8BAChB,cAAA,8OAAC;wBAAI,WAAU;;0CACb,8OAAC,0LAAI;gCACH,MAAK;gCACL,WAAU;0CACX;;;;;;0CAID,8OAAC;gCAAI,WAAU;;kDACb,8OAAC,0LAAI;wCACH,MAAK;wCACL,WAAU;kDACX;;;;;;kDAID,8OAAC,0LAAI;wCACH,MAAK;wCACL,WAAU;kDACX;;;;;;kDAID,8OAAC,0LAAI;wCACH,MAAK;wCACL,WAAU;kDACX;;;;;;kDAID,8OAAC;wCAAK,WAAU;kDACb,MAAM,SAAS;;;;;;kDAGlB,8OAAC,0LAAI;wCACH,MAAK;wCACL,WAAU;kDACX;;;;;;;;;;;;;;;;;;;;;;;8BAOP,8OAAC;oBAAK,WAAU;8BACb;;;;;;8BAGH,8OAAC,kKAAO;oBAAC,UAAS;;;;;;;;;;;;;;;;;AAI1B","debugId":null}}]
}